Bootstrap: shub
From:      Characterisation-Virtual-Laboratory/CharacterisationVL-Software:1804

%labels
MAINTAINER luhan.cheng@monash.edu
HARDWARE   cpu

%environment 
    export PATH=/opt/conda/bin:/usr/local/bin:$PATH
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
%files
    /home/luhanc/Mona0036/luhanc/metaphlan/metaphlan /opt/metaphlan/environment.yml
%post 
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    # install metaphlan3.0.1, recipe from https://hub.docker.com/layers/biobakery/metaphlan/3.0.1/images/sha256-961e220e247b92acd856c92c777e6b0954e05e8843c173821c5ed1177558b392?context=explore
    apt update -y
    apt-get install -y automake autoconf
    apt-get install -y python python-dev python3 python3-dev python3-pip apt-transport-https openjdk-8-jre wget zip
    apt-get install libgl1-mesa-glx libegl1-mesa libxrandr2 libxrandr2 libxss1 libxcursor1 libxcomposite1 libasound2 libxi6 libxtst6
    wget https://repo.anaconda.com/archive/Anaconda3-2020.07-Linux-x86_64.sh
    bash Anaconda3-2020.07-Linux-x86_64.sh -b -p /opt/conda
    export PATH=/opt/conda/bin:$PATH
    conda install -y conda
    conda update -y conda
    conda config --add channels conda-forge
    conda config --add channels bioconda
    conda env create -f /opt/metaphlan/envrionment.yml
    
    pip3 install boto3 cloudpickle awscli
    pip3 install anadama2
    apt-get install -y bowtie2
    pip3 install numpy
    pip3 install cython
    pip3 install biom-format
    apt-get install -y git
    git clone https://github.com/SegataLab/cmseq.git 
    cd cmseq 
    python3 setup.py install 
    cd ../ &&  rm -r cmseq
    
    apt install -y ncbi-blast+
    apt install -y libgsl0-dev

    # install samtools 
    cd /opt
    apt install -y gcc make libbz2-dev zlib1g-dev libncurses5-dev libncursesw5-dev liblzma-dev

    git clone https://github.com/samtools/htslib.git && cd htslib
    autoheader && autoconf
    ./configure --prefix=/usr/local/
    make -j
    make install 
    
    cd /opt
    git clone https://github.com/samtools/bcftools/ && cd bcftools
    autoheader && autoconf 
    ./configure --enable-libgsl  --prefix=/usr/local/
    make -j && make install

    cd /opt
    git clone https://github.com/samtools/samtools && cd samtools
    autoheader && autoconf -Wno-syntax 
    ./configure --prefix=/usr/local
    make -j && make install 
    

    
    pip3 install metaphlan==3.0.1
    

%runscript
    $*

