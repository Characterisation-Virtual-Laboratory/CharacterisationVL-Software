Bootstrap: docker
From: ubuntu:xenial

%post

    FREESURFER_HOME=/home/freesurfer
    apt-get update && \
        apt-get install -y build-essential \
        tcsh \
        libtool-bin \
        libtool \
        automake \
        gfortran \
        libglu1-mesa-dev \
        libfreetype6-dev \
        uuid-dev \
        libxmu-dev \
        libxmu-headers \
        libxi-dev \
        libx11-dev \
        libxml2-utils \
        libxt-dev \
        libjpeg62-dev \
        libxaw7-dev \
        liblapack-dev \
        git \
        gcc-4.8 \
        g++-4.8 \
        libgfortran-4.8-dev \
        curl \
        python-pip \
        python3-pip
    update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.8 50 && \
    update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-4.8 50
    pip3 install --upgrade pip

    cd /tmp
    wget https://github.com/freesurfer/freesurfer/archive/v6.0.0.tar.gz
    tar -xf v6.0.0.tar.gz && rm v6.0.0.tar.gz
    mv freesurfer-6.0.0/GEMS2 $FREESURFER_HOME/
    mv freesurfer-6.0.0/as_python $FREESURFER_HOME/
    cd $FREESURFER_HOME


    # Get GEMS python code and requirements

    cd $FREESURFER_HOME/GEMS2 && git clone https://github.com/pybind/pybind11.git
    pip3 install -r $FREESURFER_HOME/as_python/requirements.txt

    #Install cmake
    curl -O https://cmake.org/files/v3.10/cmake-3.10.2-Linux-x86_64.sh && sh ./cmake-3.10.2-Linux-x86_64.sh --skip-license && cp -r bin /usr/ && cp -r doc /usr/share/ && cp -r man /usr/share/ && cp -r share /usr/

    # Install ITK
    git clone https://itk.org/ITK.git
    cd $FREESURFER_HOME && mkdir ITK-build && cd ITK-build && \
        cmake ../ITK \
        -DITK_BUILD_DEFAULT_MODULES=OFF \
        -DITKGroup_Core=ON \
        -DITKGroup_Filtering=ON \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_CXX_FLAGS="-msse2 -mfpmath=sse" \
        -DCMAKE_C_FLAGS="-msse2 -mfpmath=sse" \
        && make -j8
        ITK_DIR=$FREESURFER_HOME/ITK-build

    # Build GEMS
    cd $FREESURFER_HOME/GEMS2 && \
        cmake -D CMAKE_CXX_FLAGS="-msse2 -mfpmath=sse -fPIC -fpermissive" \
        -D CMAKE_C_FLAGS="-msse2 -mfpmath=sse -fPIC -fpermissive" \
        -D BUILD_EXECUTABLES=OFF \
        -D BUILD_GUI=OFF \
        -D BUILD_MATLAB=OFF \
        -D BUILD_SHARED_LIBS=OFF \
        -D BUILD_TESTING=OFF \
        -D PYTHON_EXECUTABLE=/usr/bin/python3.5 \
        -D PYTHON_LIBRARY=/usr/lib/x86_64-linux-gnu/libpython3.5m.so \
        . && \
        make -j8

    PYTHONPATH=.:./GEMS2/bin
    SAMSEG_DATA_DIR=/data/samseg_data

    # apply patch
    wget -r --ftp-user='anonymous' --ftp-password='example@gmail.com' ftp://surfer.nmr.mgh.harvard.edu/pub/dist/freesurfer/6.0.0-patch
%environment
    export FREESURFER_HOME=/home/freesurfer
    export ITK_DIR=$FREESURFER_HOME/ITK-build
    export PYTHONPATH=.:./GEMS2/bin
    export SAMSEG_DATA_DIR=/data/samseg_data
%runscript
    /home/freesurfer
    exec /bin/bash "$@"
